Sorry about the spaghetti code, will comment the code some time later.
Will get rid of the vector of vectors stuff some time later.
