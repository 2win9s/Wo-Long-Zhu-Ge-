Sorry about the spaghetti code, will comment the code some time later.
