Sorry about the spaghetti, will comment the code some time later.
